# obus

{obus} is a temporary experimental package used to explore various
DATRAS data connections and wrapper functions to make life a little
easier for everyday user. Some of this may be taken up in a more offical
package.

## Installation

You can install the development version of imbus from
[GitHub](https://github.com/einarhjorleifsson/obus) with:

``` r
# install.packages("pak")
#pak::pak("einarhjorleifsson/obus")
```

## Table connections

``` r
library(obus)
hh <- dr_con("HH")
hl <- dr_con("HL")
ca <- dr_con("CA")
```

## A little peek

``` r
library(tidyverse)
hl |> glimpse()
#> Rows: ??
#> Columns: 19
#> Database: DuckDB 1.4.3 [unknown@Linux 5.10.0-33-amd64:R 4.4.1/:memory:]
#> $ .id                  <chr> "BITS:2017:1:DE:06SL:TVS:24001:1", "BITS:2003:4:D…
#> $ SpecCodeType         <chr> "W", "W", "W", "W", "W", "W", "W", "W", "W", "W",…
#> $ SpecCode             <chr> "126417", "126417", "126417", "126417", "126417",…
#> $ SpecVal              <chr> "1", "1", "1", "1", "1", "1", "1", "1", "1", "1",…
#> $ Sex                  <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
#> $ TotalNo              <dbl> 149.0, 158.0, 149.0, 158.0, 149.0, 221.0, 221.0, …
#> $ CatIdentifier        <int> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
#> $ NoMeas               <int> 149, 158, 149, 158, 149, 221, 221, 221, 221, 221,…
#> $ SubFactor            <dbl> 1.000, 1.000, 1.000, 1.000, 1.000, 1.000, 1.000, …
#> $ SubWgt               <int> NA, NA, NA, NA, NA, 43140, 43140, 43140, 43140, 4…
#> $ CatCatchWgt          <int> 4458, 4700, 4458, 4700, 4458, 43140, 43140, 43140…
#> $ LngtCode             <chr> "0", "0", "0", "0", "0", ".", ".", ".", ".", ".",…
#> $ LngtClass            <int> 145, 165, 150, 170, 155, 310, 320, 330, 220, 230,…
#> $ HLNoAtLngt           <dbl> 5, 4, 12, 13, 9, 1, 2, 5, 24, 24, 17, 18, 14, 10,…
#> $ DevStage             <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
#> $ LenMeasType          <chr> "1", NA, "1", NA, "1", "1", "1", "1", "1", "1", "…
#> $ ValidAphiaID         <chr> "126417", "126417", "126417", "126417", "126417",…
#> $ ScientificName_WoRMS <chr> "Clupea harengus", "Clupea harengus", "Clupea har…
#> $ DateofCalculation    <chr> "20240814", "20250401", "20240814", "20250401", "…
```

## A little exploration

``` r
library(santoku)
#> 
#> Attaching package: 'santoku'
#> The following object is masked from 'package:tidyr':
#> 
#>     chop
# Grid resolution
dx <- 1
dy <- dx / 2
# Limit analysis to certain time and space
hh |> 
  filter(Year %in% 2001:2010,
         between(ShootLong, -20, 25),
         between(ShootLat, -Inf, 65)) |> 
  # assign coordinates to grid
  mutate(lon = ShootLong%/%dx * dx + dx/2,
         lat = ShootLat%/%dy * dy + dy/2) |> 
  left_join(hl |> 
              select(.id, ScientificName_WoRMS),
           by = join_by(.id)) |>
  # analyse by grid
  group_by(lon, lat) |> 
  summarise(n_taxa = n_distinct(ScientificName_WoRMS),
            .groups = "drop") |> 
  # load data into R memory because santoku::chop not in duckdb lingo
  #  chop is also nicer than cut - keeps things more orderly
  collect() |> 
  mutate(n_taxa = chop(n_taxa, breaks = c(0, 25, 50, 75, 100, 125, 150, 200))) |> 
  ggplot(aes(lon, lat, fill = n_taxa)) +
  geom_tile() +
  scale_fill_viridis_d(option = "inferno", direction = -1) +
  coord_quickmap() +
  labs(x = NULL, y = NULL, fill = "Number of\ndistinct taxa",
       caption = "DATRAS 2001-2010, core area: Number of distinct taxa reported per rectangle")
```

![](reference/figures/README-demo-1.png)

# Package index

## All functions

- [`.dr_calc_date()`](https://einarhjorleifsson.github.io/obus/reference/dot-dr_calc_date.md)
  :

  Calculate date based on `Year`, `Month`, and `Day`.

- [`.dr_calc_length2cm()`](https://einarhjorleifsson.github.io/obus/reference/dot-dr_calc_length2cm.md)
  :

  Calculate length based on `LngtCode` and `LngtClass`.

- [`.dr_calc_n()`](https://einarhjorleifsson.github.io/obus/reference/dot-dr_calc_n.md)
  :

  Calculate column `n` based on `DataType` and `HaulDur`.

- [`.dr_calc_time()`](https://einarhjorleifsson.github.io/obus/reference/dot-dr_calc_time.md)
  :

  Calculate timestamp based on `Year`, `Month`, `Day`, and `TimeShot`.

- [`dr_coastline`](https://einarhjorleifsson.github.io/obus/reference/dr_coastline.md)
  : Coastline covering majority of DATRAS data

- [`dr_coltypes`](https://einarhjorleifsson.github.io/obus/reference/dr_coltypes.md)
  : Datras variable types

- [`dr_con()`](https://einarhjorleifsson.github.io/obus/reference/dr_con.md)
  : Create a DuckDB connection to a DATRAS dataset (latin names
  included)

- [`dr_con_exchange()`](https://einarhjorleifsson.github.io/obus/reference/dr_con_exchange.md)
  : Create a DuckDB connection to a DATRAS dataset (exchange format)

- [`dr_download_data()`](https://einarhjorleifsson.github.io/obus/reference/dr_download_data.md)
  : Download DATRAS tables

- [`dr_download_data_latin()`](https://einarhjorleifsson.github.io/obus/reference/dr_download_data_latin.md)
  : Download DATRAS latin tables

- [`dr_getCA()`](https://einarhjorleifsson.github.io/obus/reference/dr_getCA.md)
  : Retrieve DATRAS Age (CA) Table

- [`dr_getFL()`](https://einarhjorleifsson.github.io/obus/reference/dr_getFL.md)
  : Retrieve DATRAS Flex (FL) Table

- [`dr_getHH()`](https://einarhjorleifsson.github.io/obus/reference/dr_getHH.md)
  : Retrieve DATRAS Station (HH) Table

- [`dr_getHL()`](https://einarhjorleifsson.github.io/obus/reference/dr_getHL.md)
  : Retrieve DATRAS Length (HL) Table

- [`dr_get_data_latin()`](https://einarhjorleifsson.github.io/obus/reference/dr_get_data_latin.md)
  : Get DATRAS tables with latin names

- [`dr_getoverview()`](https://einarhjorleifsson.github.io/obus/reference/dr_getoverview.md)
  : Summarize Data Availability

- [`dr_settypes()`](https://einarhjorleifsson.github.io/obus/reference/dr_settypes.md)
  : Set variable types

- [`dr_tidy()`](https://einarhjorleifsson.github.io/obus/reference/dr_tidy.md)
  : Tidy DATRAS data

- [`dr_tidyca()`](https://einarhjorleifsson.github.io/obus/reference/dr_tidyca.md)
  : Tidy DATRAS age (CA) data

- [`dr_tidyfl()`](https://einarhjorleifsson.github.io/obus/reference/dr_tidyfl.md)
  : Tidy DATRAS flex (FL) data

- [`dr_tidyhh()`](https://einarhjorleifsson.github.io/obus/reference/dr_tidyhh.md)
  : Tidy DATRAS station (HH) data

- [`dr_tidyhl()`](https://einarhjorleifsson.github.io/obus/reference/dr_tidyhl.md)
  : Tidy DATRAS length (HL) data

- [`get_datras_table_base()`](https://einarhjorleifsson.github.io/obus/reference/get_datras_table_base.md)
  : Download and read DATRAS data, single-year or contiguous year-range
  only

# Articles

### All vignettes

- [Package
  overview](https://einarhjorleifsson.github.io/obus/articles/overview.md):
