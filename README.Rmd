---
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE, 
  warning = FALSE,
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# obus

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![CRAN status](https://www.r-pkg.org/badges/version/imbus)](https://CRAN.R-project.org/package=imbus)
<!-- badges: end -->

The aim of {obus} to provide users with tidy tables with non-ambiguous variables.

That said, {obus} is a temporary experimental package used to explore various DATRAS data connections and wrapper functions to make life a little easier for everyday user. Some of that may be taken up in a more official package ({icesDatras}???). Or possibly not.

For purist, one regrets to inform that this package has quite some number of dependencies (see [DESCRIPTION](https://raw.githubusercontent.com/einarhjorleifsson/obus/refs/heads/master/DESCRIPTION). If that is not your cup of tea, rewrite.


## Installation

You can install the development version of {obus} from [GitHub](https://github.com/einarhjorleifsson/obus) with:

``` r
remotes::install_github("einarhjorleifsson/obus")
```

In some cases {obus} uses wrapper functions depending on {icesDatras} features that have, as of yet, not been taken up in the official ICES version (issues pending) install that package via:

``` r
remotes::install_github("einarhjorleifsson/icesDatras")
```

There are two ways to connect to the DATRAS data, either by importing the whole datasets into R or by making an in-process DuckDB database connection.

```{r}
library(obus)
```

## Importing

The fastest way to **import** the full DATRAS data into R is:

```{r}
system.time({
  hh <- dr_get("HH", from = "parquet")
  hl <- dr_get("HL", from = "parquet")
  ca <- dr_get("CA", from = "parquet")
})
```

So we are talking about less than 5 seconds if you sitting on the optic fiber. If you are connected via wifi this may take closer to 60 seconds. Whatever the case one can assume that nobody will complain given that the dimension just imported are as follows:

```{r, echo = FALSE}
library(tidyverse)
tibble(type = c("HL", "HH", "CA"),
       rows = c(nrow(hh), nrow(hl), nrow(ca)),
       cols = c(ncol(hh), ncol(hl), ncol(ca))) |> 
  knitr::kable(caption = "Number of records and variables")
```

## Connecting

Although the DATRAS data can not be considered big data, we can pretend that it is and use techniques developed for big data. So instead of importing the full dataset one can generate a connection to the main DATRAS tables by:

### HH data

```{r}
hh <- dr_con("HH")
hh |> glimpse()
```

### HL data

```{r}
hl <- dr_con("HL")
hl |> glimpse()
```

### CA data

```{r}
ca <- dr_con("CA")
ca |> glimpse()
```

## Small print

The parquet data source is as of now **not** mirror of the data residing at ICES, it is just a copy that may be some weeks old. If you want an up-to-date mirror you are better off for now using a slower route, doing:

```{r, eval = FALSE}
system.time({
  hh <- dr_get("HH", from = "new")
  hl <- dr_get("HL", from = "new")
  ca <- dr_get("CA", from = "new")
})
```

The above is just a wrapper around the latest kid on the block: 'icesDatras::get_datras_unaggregated_data'.

So the latest record, as of the generation of this document is:

```{r}
library(tidyverse)
hh |> 
  mutate(date = make_date(Year, Month, Day)) |> 
  filter(date == max(date)) |> 
  glimpse()
```

## Warning

The package has still has some hangover functions that need to be removed.

## What was used

```{r, echo = FALSE}
devtools::session_info()
```

